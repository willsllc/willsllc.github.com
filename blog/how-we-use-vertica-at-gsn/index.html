<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <title>How we use Vertica at GSN</title>

    <link rel="stylesheet" href="../../stylesheets/styles.css">
    <link rel="stylesheet" href="../../stylesheets/pygment_trac.css">
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
	<style>
		.highlight { background-color: #ffff99; }
	</style>
  </head>
  <body>
    <div class="wrapper">
      <header>
        <h1>Portman Wills</h1>
        <p>Pages</p>


        <p class="view"><a href="https://github.com/willsllc">View My GitHub Profile</a></p>

      </header>
      <section>
        <h2>How we use Vertica at GSN</h2>

		<p>
At <a href="http://www.gsngames.com">GSN Games</a>, we’re obsessed with two things: <strong>measuring data </strong> and <strong>moving fast</strong>.  We try to take new ideas from conception to production in 2 days.  So traditional data warehousing solutions &mdash; you know, the ones that <a href="http://www.sas.com/" title="Just kidding, SAS. I love you.">take 6 months to implement</a> &mdash; would never work for us. 		
		</p>
		<p>
So here’s how we use <a href="http://www.vertica.com"><strong>Vertica and SQL</strong></a> to collect data and still move quickly.		
		</p>
		
		<h3>A very simple schema</h3>
		<p><span class="highlight">We store all of our data in a single table, named <code>events</code>.</span> The first four columns look perfectly normal:</p>
		<ul>
			<li><code>user_id</code></li>
			<li><code>event_type_id</code></li>
			<li><code>event_time</code></li>
			<li><code>game_id</code></li>
		</ul>
		<p>The next 120 columns look a little odd:</p>
		<ul>
			<li><code>attr1</code></li>
			<li><code>attr2</code></li>
			<li><code>attr3</code></li>
			<li>...</li>
			<li><code>attr120</code></li>
		</ul>
		<p>
			<blockquote>
			“Wait, that’s the kind of database that Dilbert’s boss would create! YOU’RE DOING IT WRONG!”</blockquote>
		</p>
		<p>Please hold all of your nerdrage until the end of this article.</p>
		<p>
			<blockquote>
			“Ok, but I’m extremely skeptical right now.”
			</blockquote>
		</p>
		<p>
		As was I when I initially saw this design. You'll come around. 
		</p>
		<p>The first 20 columns are for <code>integer</code>s, the next 20 for <code>float</code>s, the next 20 for <code>boolean</code>s, then next 20 for <code>timestamp</code>s, and the last 40 are for <code>string</code>s. 
		</p>
		<p>
		<code>event_type_id</code> is a <a href="https://www.google.com/search?q=discriminator+column">“discriminator column”</a>: it tells us what <em>kind</em> of data is in each column in that row. 
		</p>
		<p>We have lots of different events that we record, and frequently add new ones. We keep track of what data is in what column with a big Google Spreadsheet that looks like this:</p>
		<a href="column-definitions.PNG" title="click to enlarge"><img src="column-definitions.PNG" alt="A screenshot of one section of our master column definition Google Spreadsheet"/></a>
		<p>
		So for the <code>PAYMENT_RECEIVED</code> event, <code>attr1</code> stores the amount of money the user paid us, but for the <code>TOKENS_ADJUSTED</code> event, <code>attr1</code> stores the number of tokens won or lost in a game.
		</p>
		<p>
		We use this Google doc to easily <span class="highlight">generate SQL views for each event type</span>. So to the casual observer, it looks like a normal RDBMS, with one table for each event, but under the hood it's one table to rule them all, forged by Sauron.
		</p>
		<p><blockquote>“What's S-A-U-R-O-N?”</blockquote></p>
		<p>Tough crowd. Moving on...</p>
		
		
		<h3>Getting data in...</h3>
		<p>
		This schema allows our game developers and platform engineers to <strong>launch new features without involving the BI team</strong>. Our app servers write to a flat <code>.csv</code> file. So if a developer comes up with a new feature and wants to begin logging metrics, this is what they do:
		</p>
		<ol>
			<li>Create a new event type id</li>
			<li>Add a new row to the Google Doc</li>
			<li>Add some code to write lines to the standard log file</li>
		</ol>
		<p>
		The log files rollover every 10MB, at which point they are uploaded to S3 for ingestion by the data warehouse.
		</p>
		<p>Every 15 minutes, the data warehouse downloads all the log files from S3, and uses the Vertica <code>copy</code> copy command to write them to the <code>events</code> table.
		</p>
		<p>
		<em>Et voilà!</em> An engineer has successfully started logging new data into Vertica, and I didn't have to do anything.
		</p>
		<p><blockquote>“Wow, you’re lazy.”</blockquote></p>
		<p>Correct! Moving on...</p>
		
		
		<h3>Getting information out...</h3>
		<p>
		
	  
	  </section>
	  <footer>
        <p><small>Hosted on GitHub Pages &mdash; Theme by <a href="https://github.com/orderedlist">orderedlist</a></small></p>
      </footer>
    </div>
    <script src="../../javascripts/scale.fix.js"></script>
    
  </body>
</html>